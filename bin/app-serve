#!/usr/bin/env php
<?php

$server = [
    'host' => 'localhost',
    'port' => 8000,
    'root' => dirname(__DIR__),
    'router' => 'server.php',
];


$command = sprintf('php -S %s:%d -t %s %s', $server['host'], $server['port'], $server['root'], $server['router']);


$routerFile = sprintf('%s/%s', $server['root'], $server['router']);
$routerContent = <<<PHP
<?php
// This is an autogenerated file used for development server.
// You can safely delete this file if you wish to.
// It will get regenerated again when running "php bin/app-serve".

\$blackListedPaths = '/\/bin\/|\/storage\/cache\/|\/storage\/views\/|\.php|\.phtml/i';
\$requestedAppPath = urldecode(parse_url(\$_SERVER['REQUEST_URI'], PHP_URL_PATH));

if (!preg_match(\$blackListedPaths, \$requestedAppPath)) {
    return false;
}

\$index = __DIR__ . '/index.php';
if (!file_exists(\$index)) {
    \$index = __DIR__ . '/public/index.php';
}

require \$index;
PHP;


if (file_exists($routerFile) == false || file_get_contents($routerFile) !== $routerContent) {
    file_put_contents($routerFile, $routerContent);
}


echo shell_exec($command);

echo 'OK! ' . PHP_EOL;
